[gcode_macro AXIS_TEST]
description: Axis / CoreXY motor torture test on A,B,X,Y,Z
gcode:
  {% set cycles = params.CYCLES|default(100)|int %}
  {% set axis = params.AXIS|default("Z")|upper %}
  {% set move = params.AMP|default(1)|float %}

  {% set x_mid = printer.toolhead.axis_maximum.x / 2 %}
  {% set y_mid = printer.toolhead.axis_maximum.y / 2 %}
  {% set z_mid = printer.toolhead.axis_maximum.z / 2 %}

  {% if axis == "Z" %}
    {% set speed = params.SPEED|default(600)|float %}
  {% else %}
    {% set speed = params.SPEED|default(6000)|float %}
  {% endif %}

  {% set safe = True %}

  {% if axis == "X" and move > x_mid %}
    {% set safe = False %}
  {% elif axis == "Y" and move > y_mid %}
    {% set safe = False %}
  {% elif axis == "Z" and move > z_mid %}
    {% set safe = False %}
  {% elif axis == "A" and (move > x_mid or move > y_mid) %}
    {% set safe = False %}
  {% elif axis == "B" and (move > x_mid or move > y_mid) %}
    {% set safe = False %}
  {% endif %}

  {% if axis not in ["X","Y","Z","A","B"] %}
    M117 Invalid AXIS! Use: X Y Z A B
    RESPOND PREFIX=‚ùå MSG="AXIS_TEST: Invalid AXIS. Valid options: X Y Z A B"
    {% set safe = False %}
  {% endif %}

  {% if not safe %}
    RESPOND PREFIX=‚ùå MSG="AXIS_TEST aborted: AMP exceeds safe bounds."
    M117 AMP TOO LARGE
  {% else %}
    M117 {axis} Test Starting

    G90
    G1 X{x_mid} Y{y_mid} F6000
    G1 Z{z_mid} F1200

    {% if axis == "X" %}
      {% for i in range(cycles) %}
        G1 X{x_mid + move} F{speed}
        G1 X{x_mid - move} F{speed}
      {% endfor %}
      G1 X{x_mid}

    {% elif axis == "Y" %}
      {% for i in range(cycles) %}
        G1 Y{y_mid + move} F{speed}
        G1 Y{y_mid - move} F{speed}
      {% endfor %}
      G1 Y{y_mid}

    {% elif axis == "Z" %}
      {% for i in range(cycles) %}
        G1 Z{z_mid + move} F{speed}
        G1 Z{z_mid - move} F{speed}
      {% endfor %}
      G1 Z{z_mid}

    {% elif axis == "A" %}
      {% for i in range(cycles) %}
        G1 X{x_mid + move} Y{y_mid - move} F{speed}
        G1 X{x_mid - move} Y{y_mid + move} F{speed}
      {% endfor %}
      G1 X{x_mid} Y{y_mid}

    {% elif axis == "B" %}
      {% for i in range(cycles) %}
        G1 X{x_mid + move} Y{y_mid + move} F{speed}
        G1 X{x_mid - move} Y{y_mid - move} F{speed}
      {% endfor %}
      G1 X{x_mid} Y{y_mid}
    {% endif %}

    M117 {axis} Test Done
    RESPOND PREFIX=üëç MSG="{axis} Test Done"
  {% endif %}